<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <title>Studio Novel Minimal v2.1 — Editor + Backup + Mod Buku</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --card:#ffffff;
      --border:#d4d4dd;
      --border-soft:#e3e3ec;
      --ink:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:#e0ecff;
      --danger:#b91c1c;
      --radius:10px;
      --shadow:0 8px 24px rgba(15,23,42,0.06);

      --book-paper:#fbfbf8;
      --book-ink:#111827;
      --book-muted:#6b7280;
      --book-shadow:0 16px 40px rgba(15,23,42,0.16);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,sans-serif;}
    body{
      background:linear-gradient(135deg,#f9fafb,#eef1f7);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      padding:12px 20px;
      border-bottom:1px solid var(--border-soft);
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(10px);
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    header .title{font-weight:600; letter-spacing:.02em; font-size:15px;}
    header .subtitle{font-size:12px; color:var(--muted);}
    header .right{display:flex; align-items:center; gap:8px; font-size:11px; color:var(--muted);}
    header .pill{padding:4px 10px; border-radius:999px; border:1px solid var(--border-soft); background:#f9fafb; white-space:nowrap;}

    main{display:flex; flex:1; padding:16px; gap:16px;}

    /* Sidebar */
    .sidebar{
      width:285px; max-width:100%;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .section-title{font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);}
    .field-label{font-size:11px; color:var(--muted); margin-bottom:4px;}
    select,input[type="text"]{
      width:100%; padding:7px 9px;
      border-radius:7px; border:1px solid var(--border);
      font-size:12px; outline:none; background:#f9fafb;
    }
    select:focus,input[type="text"]:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,0.16);
    }
    .btn{
      font-size:12px; padding:7px 10px;
      border-radius:7px; border:1px solid transparent;
      background:#e5e7eb; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      white-space:nowrap;
    }
    .btn-primary{background:var(--accent); color:#fff;}
    .btn-outline{background:#f9fafb; border-color:var(--border);}
    .btn-ghost{background:transparent; border-color:transparent;}
    .btn-sm{padding:5px 8px; font-size:11px;}
    .btn-danger{background:#fee2e2; border-color:#fecaca; color:#b91c1c;}
    .btn:disabled{opacity:.5; cursor:not-allowed;}

    .sidebar-actions{display:flex; flex-wrap:wrap; gap:6px;}
    .work-list{
      border-top:1px solid var(--border-soft);
      padding-top:8px; margin-top:4px;
      flex:1; overflow:auto;
    }
    .work-item{
      padding:7px 8px;
      border-radius:7px;
      border:1px solid transparent;
      cursor:pointer;
      margin-bottom:4px;
      display:flex; flex-direction:column; gap:2px;
    }
    .work-item.active{
      border-color:var(--accent);
      background:var(--accent-soft);
    }
    .work-item .title{font-size:12px; font-weight:500;}
    .work-item .meta{
      font-size:11px; color:var(--muted);
      display:flex; justify-content:space-between; gap:4px;
    }
    .badge{
      font-size:10px; padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:#f9fafb;
    }
    .badge-backup{
      border-color:#f97373; color:#b91c1c; background:#fef2f2;
    }

    /* Editor panel */
    .editor-panel{
      flex:1; min-width:0;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .editor-top{
      display:flex; flex-wrap:wrap;
      gap:8px 10px; align-items:flex-end;
      border-bottom:1px solid var(--border-soft);
      padding-bottom:8px;
    }
    .field-group{display:flex; flex-direction:column; gap:4px; min-width:160px;}
    .editor-actions{
      margin-left:auto;
      display:flex; flex-wrap:wrap; gap:6px; align-items:center;
    }
    .chapters-bar{
      display:flex; align-items:center; gap:6px;
      margin-top:4px;
      border-bottom:1px solid var(--border-soft);
      padding-bottom:4px;
      overflow:auto;
    }
    .chapter-tab{
      padding:4px 10px; border-radius:999px;
      border:1px solid transparent;
      font-size:11px; cursor:pointer;
      background:#f3f4f6; white-space:nowrap;
    }
    .chapter-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:var(--accent);
      font-weight:500;
    }
    textarea{
      width:100%;
      min-height:330px;
      resize:vertical;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:13px;
      line-height:1.55;
      background:#f9fafb;
      margin-top:6px;
      white-space:pre-wrap;
    }
    .editor-footer{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      gap:8px;
      flex-wrap:wrap;
    }
    .status-dirty{color:var(--danger);}
    .status-clean{color:var(--muted);}
    .status-saved{color:var(--accent);}

    .hint{
      font-size:11px;
      color:var(--muted);
      padding:6px 8px;
      border-radius:7px;
      background:#f9fafb;
      border:1px dashed var(--border-soft);
      margin-top:4px;
    }

    /* Cover */
    .cover-row{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      margin-top:6px;
    }
    .cover-thumb{
      width:64px; height:86px;
      border-radius:8px; border:1px solid var(--border);
      background:#f3f4f6;
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .cover-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .cover-meta{
      font-size:11px; color:var(--muted);
      display:flex; flex-direction:column; gap:3px;
      min-width:180px;
    }
    .cover-actions{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-left:auto;
    }

    /* Debug log */
    .logbox{
      font-size:11px;
      color:#0f172a;
      background:#f8fafc;
      border:1px solid var(--border-soft);
      border-radius:8px;
      padding:8px;
      max-height:120px;
      overflow:auto;
    }
    .logbox b{color:#111827;}
    .logline{color:#475569; margin-top:4px; white-space:pre-wrap;}

   /* BOOK MODE — FIX: auto fit to viewport height */
.book-overlay{
  position:fixed; inset:0;
  background:rgba(17,24,39,0.65);
  z-index:999;
  display:none;
  padding:10px;                 /* kecilkan padding supaya lebih muat */
}
.book-overlay.show{display:flex;}

.book-shell{
  width:min(1100px, 100%);
  height:100%;
  margin:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.book-topbar{
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  color:#fff;
  font-size:12px;
}

.book-stage{
  flex:1 1 auto;                /* ambil ruang tengah */
  min-height:0;                 /* penting untuk elak overflow flex */
  display:flex;
  justify-content:center;
  align-items:center;
}

.book{
  /* KUNCI UTAMA: ikut tinggi viewport, bukan aspect-ratio semata */
  width:100%;
  max-width:980px;
  height:100%;
  max-height:calc(100vh - 170px); /* 170px = topbar + nav + padding (lebih selamat) */
  position:relative;
  filter: drop-shadow(var(--book-shadow));
}

.spread{
  position:absolute; inset:0;
  display:grid;
  grid-template-columns:1fr 1fr;
  border-radius:16px;
  overflow:hidden;
  background:var(--book-paper);
}

/* Mobile: 1 page view, tetap fit */
@media (max-width:800px){
  .book{ max-height:calc(100vh - 190px); }
  .spread{ grid-template-columns:1fr; }
  .page.right{ display:none; }
}
    .page{
      padding:28px 28px 22px 28px;
      color:var(--book-ink);
      overflow:hidden;
      position:relative;
      border-right:1px solid rgba(0,0,0,0.06);
    }
    .page.right{border-right:none; border-left:1px solid rgba(0,0,0,0.06);}
    .page .pnum{
      position:absolute;
      bottom:10px; left:0; right:0;
      text-align:center;
      font-size:11px;
      color:var(--book-muted);
    }
    .page .h1{font-weight:800; font-size:20px; margin-bottom:10px;}
    .page .h2{font-weight:600; font-size:13px; color:var(--book-muted); margin-bottom:12px;}
    .page .content{height:100%; overflow:hidden; font-size:14px; line-height:1.65; white-space:pre-wrap;}

    .cover{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:14px;
    }
    .cover .coverImg{
      width:100%;
      height:62%;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.10);
      background:#f1f5f9;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cover .coverImg img{width:100%;height:100%;object-fit:cover;display:block;}
    .cover .coverTitle{font-size:28px; font-weight:900; letter-spacing:.02em;}
    .cover .coverAuthor{color:var(--book-muted); font-size:13px; margin-top:4px;}
    .cover .coverFooter{color:var(--book-muted); font-size:11px; display:flex; justify-content:space-between;}

    .book-nav{
      display:flex; justify-content:center; align-items:center;
      gap:10px; flex-wrap:wrap;
      color:#fff; font-size:12px;
    }
    .book-nav .counter{
      opacity:.9;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,0.25);
      border-radius:999px;
      background:rgba(255,255,255,0.10);
    }

    @media (max-width:800px){
      main{flex-direction:column;}
      .sidebar{width:100%; order:2;}
      .editor-panel{order:1;}
      .book{aspect-ratio: 10/14;}
      .spread{grid-template-columns:1fr;}
      .page.right{display:none;}
    }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">Studio Novel Minimal v2.1</div>
    <div class="subtitle">Simpan, sunting, backup & mod buku — lokal & offline</div>
  </div>
  <div class="right">
    <div class="pill">localStorage</div>
  </div>
</header>

<main>
  <aside class="sidebar">
    <div class="section-title">Senarai Karya</div>

    <div>
      <div class="field-label">Tapis mengikut genre</div>
      <select id="genreFilter">
        <option value="">Semua genre</option>
        <option value="Novel">Novel</option>
        <option value="Cerpen">Cerpen</option>
        <option value="Puisi">Puisi</option>
        <option value="Catatan">Catatan</option>
      </select>
    </div>

    <div class="sidebar-actions">
      <button class="btn btn-primary btn-sm" id="btnNewWork">+ Karya baharu</button>
      <label class="btn btn-outline btn-sm" for="importCsvInput">Import CSV</label>
      <input type="file" id="importCsvInput" accept=".csv,text/csv" style="display:none">
      <button class="btn btn-outline btn-sm" id="btnExportCsv">Eksport CSV</button>
      <button class="btn btn-danger btn-sm" id="btnReset">Reset Data</button>
    </div>

    <div class="work-list" id="workList"></div>

    <div class="section-title" style="margin-top:6px;">Log</div>
    <div class="logbox" id="logbox">
      <b>Status:</b> sedia.
      <div class="logline" id="logline"></div>
    </div>
  </aside>

  <section class="editor-panel">
    <div class="editor-top">
      <div class="field-group">
        <label class="field-label" for="genreInput">Genre</label>
        <select id="genreInput">
          <option value="">(Pilih / taip)</option>
          <option value="Novel">Novel</option>
          <option value="Cerpen">Cerpen</option>
          <option value="Puisi">Puisi</option>
          <option value="Catatan">Catatan</option>
        </select>
      </div>

      <div class="field-group" style="flex:1;min-width:220px;">
        <label class="field-label" for="titleInput">Tajuk karya</label>
        <input type="text" id="titleInput" placeholder="Contoh: SAKSI">
      </div>

      <div class="editor-actions">
        <button class="btn btn-outline btn-sm" id="btnBookMode">Mod Buku</button>
        <button class="btn btn-outline btn-sm" id="btnDuplicate">Salinan manuskrip</button>
        <button class="btn btn-primary btn-sm" id="btnSave">Simpan</button>
      </div>
    </div>

    <div class="cover-row">
      <div class="cover-thumb" id="coverThumb">
        <span style="font-size:10px;color:#6b7280;">Tiada cover</span>
      </div>

      <div class="cover-meta">
        <div><b>Kulit buku</b> (JPG/PNG)</div>
        <div>Imej diperkecil automatik untuk jimat storan.</div>
      </div>

      <div class="cover-actions">
        <label class="btn btn-outline btn-sm" for="coverInput">Muat naik cover</label>
        <input id="coverInput" type="file" accept="image/*" style="display:none">
        <button class="btn btn-outline btn-sm" id="btnRemoveCover">Buang cover</button>
      </div>
    </div>

    <div class="chapters-bar" id="chapterTabs"></div>
    <textarea id="chapterContent" placeholder="Mula menulis bab di sini..."></textarea>

    <div class="editor-footer">
      <div id="statusText" class="status-clean">Tiada karya dipilih.</div>
      <div>
        <span id="wordCount">0</span> perkataan ·
        <button class="btn btn-ghost btn-sm" id="btnAddChapter">+ Bab</button>
      </div>
    </div>

    <div class="hint">
      Import/Export CSV v2.1 adalah stabil (koma/newline/cover).  
      Mod Buku memecahkan teks kepada halaman secara automatik.
    </div>
  </section>
</main>

<!-- BOOK MODE -->
<div class="book-overlay" id="bookOverlay" aria-hidden="true">
  <div class="book-shell">
    <div class="book-topbar">
      <div class="left">
        <div class="t1" id="bookTitle">—</div>
        <div class="t2" id="bookMeta">—</div>
      </div>
      <div class="actions">
        <button class="btn btn-outline btn-sm" id="btnBookPrev">◀ Sebelumnya</button>
        <button class="btn btn-outline btn-sm" id="btnBookNext">Seterusnya ▶</button>
        <button class="btn btn-outline btn-sm" id="btnBookClose">Tutup</button>
      </div>
    </div>

    <div class="book-stage">
      <div class="book">
        <div class="spread">
          <div class="page left">
            <div class="content" id="bookLeft"></div>
            <div class="pnum" id="pnumLeft"></div>
          </div>
          <div class="page right">
            <div class="content" id="bookRight"></div>
            <div class="pnum" id="pnumRight"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="book-nav">
      <div class="counter" id="bookCounter">Halaman —</div>
      <div class="counter" style="opacity:.85;">Kekunci: ← / → , Esc</div>
    </div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = 'novelStudioData_v21';

  const state = {
    works: [],
    currentWorkId: null,
    currentChapterIndex: 0,
    isDirty: false,
    lastSavedAt: null,

    // Book mode
    bookPages: [],
    bookIndex: 0
  };

  const $ = id => document.getElementById(id);

  const els = {
    genreFilter: $('genreFilter'),
    workList: $('workList'),

    genreInput: $('genreInput'),
    titleInput: $('titleInput'),
    chapterTabs: $('chapterTabs'),
    chapterContent: $('chapterContent'),
    statusText: $('statusText'),
    wordCount: $('wordCount'),

    btnNewWork: $('btnNewWork'),
    btnDuplicate: $('btnDuplicate'),
    btnSave: $('btnSave'),
    btnAddChapter: $('btnAddChapter'),
    btnExportCsv: $('btnExportCsv'),
    importCsvInput: $('importCsvInput'),
    btnReset: $('btnReset'),

    coverInput: $('coverInput'),
    coverThumb: $('coverThumb'),
    btnRemoveCover: $('btnRemoveCover'),

    logline: $('logline'),

    btnBookMode: $('btnBookMode'),
    bookOverlay: $('bookOverlay'),
    btnBookClose: $('btnBookClose'),
    btnBookPrev: $('btnBookPrev'),
    btnBookNext: $('btnBookNext'),
    bookTitle: $('bookTitle'),
    bookMeta: $('bookMeta'),
    bookLeft: $('bookLeft'),
    bookRight: $('bookRight'),
    pnumLeft: $('pnumLeft'),
    pnumRight: $('pnumRight'),
    bookCounter: $('bookCounter')
  };

  function log(msg){
    const t = new Date().toLocaleString('ms-MY');
    els.logline.textContent = `[${t}] ${msg}`;
    console.log(msg);
  }

  // ===== Storage =====
  function loadFromStorage(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const works = JSON.parse(raw);
      if(Array.isArray(works)) state.works = works;
      log(`Load: ${state.works.length} karya.`);
    }catch(e){
      console.error(e);
      log('Load gagal (data rosak).');
    }
  }

  function saveToStorage(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.works));
      state.lastSavedAt = new Date();
      log('Simpan ke localStorage berjaya.');
    }catch(e){
      console.error(e);
      alert('Gagal simpan. Mungkin storan browser penuh. Cuba buang cover/kurangkan saiz.');
      log('Simpan gagal: storan penuh?');
    }
  }

  // ===== Core data =====
  function createWork(){
    const id = 'w_' + Date.now() + '_' + Math.random().toString(16).slice(2);
    return {
      id,
      genre: '',
      title: 'Karya tanpa tajuk',
      author: 'Mazlee Ahmad',
      isBackup: false,
      coverDataUrl: '',
      chapters: [{ content:'', updatedAt:null }]
    };
  }

  function getCurrentWork(){
    return state.works.find(w => w.id === state.currentWorkId) || null;
  }

  function getCurrentChapter(){
    const w = getCurrentWork();
    if(!w) return null;
    return w.chapters[state.currentChapterIndex] || null;
  }

  // ===== Status/Dirty =====
  function updateStatus(text, mode){
    els.statusText.textContent = text;
    els.statusText.className = '';
    els.statusText.classList.add(
      mode === 'dirty' ? 'status-dirty' :
      mode === 'saved' ? 'status-saved' :
      'status-clean'
    );
  }
  function markDirty(){
    state.isDirty = true;
    updateStatus('Perubahan belum disimpan', 'dirty');
  }
  function confirmIfDirty(){
    if(!state.isDirty) return true;
    return confirm('Ada suntingan belum disimpan. Teruskan tanpa simpan?');
  }

  function countWords(text){
    if(!text) return 0;
    return text.trim().split(/\s+/).filter(Boolean).length;
  }

  // ===== Render =====
  function renderWorkList(){
    const filter = els.genreFilter.value || '';
    els.workList.innerHTML = '';

    if(state.works.length === 0){
      const div = document.createElement('div');
      div.style.fontSize = '11px';
      div.style.color = '#6b7280';
      div.textContent = 'Tiada karya lagi. Klik "Karya baharu".';
      els.workList.appendChild(div);
      return;
    }

    state.works.forEach(work => {
      if(filter && work.genre !== filter) return;

      const item = document.createElement('div');
      item.className = 'work-item' + (work.id === state.currentWorkId ? ' active' : '');

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = work.title || '(Tanpa tajuk)';

      const meta = document.createElement('div');
      meta.className = 'meta';

      const g = document.createElement('span');
      g.textContent = work.genre || 'Genre?';
      g.className = 'badge';
      meta.appendChild(g);

      if(work.isBackup){
        const b = document.createElement('span');
        b.textContent = 'Backup';
        b.className = 'badge badge-backup';
        meta.appendChild(b);
      }

      item.appendChild(title);
      item.appendChild(meta);

      item.addEventListener('click', () => handleSwitchWork(work.id));
      els.workList.appendChild(item);
    });
  }

  function renderCoverThumb(){
    const w = getCurrentWork();
    els.coverThumb.innerHTML = '';
    if(!w || !w.coverDataUrl){
      els.coverThumb.innerHTML = '<span style="font-size:10px;color:#6b7280;">Tiada cover</span>';
      return;
    }
    const img = document.createElement('img');
    img.src = w.coverDataUrl;
    els.coverThumb.appendChild(img);
  }

  function renderEditor(){
    const w = getCurrentWork();

    const disabled = !w;
    els.chapterContent.disabled = disabled;
    els.btnSave.disabled = disabled;
    els.btnDuplicate.disabled = disabled;
    els.btnAddChapter.disabled = disabled;
    els.btnBookMode.disabled = disabled;
    els.btnRemoveCover.disabled = disabled;

    if(!w){
      els.genreInput.value = '';
      els.titleInput.value = '';
      els.chapterTabs.innerHTML = '';
      els.chapterContent.value = '';
      els.wordCount.textContent = '0';
      updateStatus('Tiada karya dipilih.', 'clean');
      renderCoverThumb();
      return;
    }

    // safe guard
    if(!Array.isArray(w.chapters) || w.chapters.length === 0) w.chapters = [{content:'',updatedAt:null}];
    if(state.currentChapterIndex >= w.chapters.length) state.currentChapterIndex = 0;

    els.genreInput.value = w.genre || '';
    els.titleInput.value = w.title || '';

    // tabs bab
    els.chapterTabs.innerHTML = '';
    w.chapters.forEach((_, idx) => {
      const tab = document.createElement('button');
      tab.type = 'button';
      tab.className = 'chapter-tab' + (idx === state.currentChapterIndex ? ' active' : '');
      tab.textContent = 'Bab ' + (idx + 1);
      tab.addEventListener('click', () => handleSwitchChapter(idx));
      els.chapterTabs.appendChild(tab);
    });

    const ch = getCurrentChapter();
    els.chapterContent.value = ch ? ch.content : '';
    els.wordCount.textContent = countWords(els.chapterContent.value);

    renderCoverThumb();

    if(state.isDirty){
      updateStatus('Perubahan belum disimpan', 'dirty');
    }else if(state.lastSavedAt){
      updateStatus('Terkini disimpan: ' + state.lastSavedAt.toLocaleString('ms-MY'), 'saved');
    }else{
      updateStatus('Sedia untuk menulis.', 'clean');
    }
  }

  // ===== Sync =====
  function syncEditorToState(){
    const w = getCurrentWork();
    if(!w) return;
    const ch = w.chapters[state.currentChapterIndex];
    if(!ch) return;
    ch.content = els.chapterContent.value;
    ch.updatedAt = new Date().toISOString();
  }

  // ===== Handlers =====
  function handleNewWork(){
    if(!confirmIfDirty()) return;
    const w = createWork();
    state.works.unshift(w);
    state.currentWorkId = w.id;
    state.currentChapterIndex = 0;
    state.isDirty = false;
    renderWorkList();
    renderEditor();
    log('Karya baharu dicipta.');
  }

  function handleSwitchWork(id){
    if(id === state.currentWorkId) return;
    if(!confirmIfDirty()) return;
    syncEditorToState();
    state.currentWorkId = id;
    state.currentChapterIndex = 0;
    state.isDirty = false;
    renderWorkList();
    renderEditor();
    log('Tukar karya.');
  }

  function handleSwitchChapter(idx){
    if(idx === state.currentChapterIndex) return;
    if(!confirmIfDirty()) return;
    syncEditorToState();
    state.currentChapterIndex = idx;
    state.isDirty = false;
    renderEditor();
    log(`Tukar bab: ${idx+1}.`);
  }

  function handleSave(){
    const w = getCurrentWork();
    if(!w) return;
    w.genre = els.genreInput.value.trim();
    w.title = els.titleInput.value.trim() || 'Karya tanpa tajuk';
    syncEditorToState();
    saveToStorage();
    state.isDirty = false;
    renderWorkList();
    renderEditor();
  }

  function handleDuplicate(){
    const w = getCurrentWork();
    if(!w) return;
    if(!confirm('Hasilkan salinan (backup) manuskrip ini?')) return;

    const copy = JSON.parse(JSON.stringify(w));
    copy.id = 'w_' + Date.now() + '_' + Math.random().toString(16).slice(2);
    copy.title = (w.title || 'Karya') + ' (Salinan / Backup)';
    copy.isBackup = true;
    state.works.unshift(copy);
    saveToStorage();
    renderWorkList();
    log('Backup dibuat.');
  }

  function handleAddChapter(){
    const w = getCurrentWork();
    if(!w) return;
    if(!confirmIfDirty()) return;
    syncEditorToState();

    w.chapters.push({content:'',updatedAt:null});
    state.currentChapterIndex = w.chapters.length - 1;
    state.isDirty = false;
    renderEditor();
    log('Bab baharu ditambah.');
  }

  function handleGenreChange(){
    const w = getCurrentWork();
    if(!w) return;
    w.genre = els.genreInput.value.trim();
    markDirty();
    renderWorkList();
  }

  function handleTitleChange(){
    const w = getCurrentWork();
    if(!w) return;
    w.title = els.titleInput.value.trim();
    markDirty();
    renderWorkList();
  }

  function handleContentInput(){
    const ch = getCurrentChapter();
    if(!ch) return;
    ch.content = els.chapterContent.value;
    ch.updatedAt = new Date().toISOString();
    els.wordCount.textContent = countWords(els.chapterContent.value);
    markDirty();
  }

  // ===== Cover upload (resize) =====
  function readImageAsDataUrl(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  function resizeImageDataUrl(dataUrl, maxW=900, maxH=1200, quality=0.82){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        const ratio = Math.min(maxW/w, maxH/h, 1);
        w = Math.round(w*ratio);
        h = Math.round(h*ratio);

        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        try{
          resolve(canvas.toDataURL('image/jpeg', quality));
        }catch(e){
          resolve(dataUrl);
        }
      };
      img.onerror = () => resolve(dataUrl);
      img.src = dataUrl;
    });
  }

  async function handleCoverUpload(e){
    const w = getCurrentWork();
    if(!w) return;
    const file = e.target.files[0];
    if(!file) return;

    try{
      const raw = await readImageAsDataUrl(file);
      const resized = await resizeImageDataUrl(raw, 900, 1200, 0.82);
      w.coverDataUrl = resized;
      markDirty();
      renderCoverThumb();
      log('Cover dimuat naik.');
    }catch(err){
      console.error(err);
      alert('Gagal muat naik cover.');
      log('Cover gagal muat naik.');
    }finally{
      e.target.value = '';
    }
  }

  function handleRemoveCover(){
    const w = getCurrentWork();
    if(!w || !w.coverDataUrl) return;
    if(!confirm('Buang cover untuk karya ini?')) return;
    w.coverDataUrl = '';
    markDirty();
    renderCoverThumb();
    log('Cover dibuang.');
  }

  // ===== CSV robust (quoted, supports newline) =====
  function csvEscape(v){
    const s = (v ?? '').toString();
    return `"${s.replace(/"/g, '""')}"`;
  }

  function parseCsvLine(line){
    const out = [];
    let cur = '';
    let inQ = false;

    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(inQ){
        if(ch === '"'){
          if(line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = false;
        }else{
          cur += ch;
        }
      }else{
        if(ch === '"') inQ = true;
        else if(ch === ','){ out.push(cur); cur = ''; }
        else cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  function handleExportCsv(){
    if(state.works.length === 0){
      alert('Tiada karya untuk dieksport.');
      log('Eksport: tiada karya.');
      return;
    }
    const header = [
      'work_id','genre','title','author','is_backup','cover_dataurl','chapter_index','content','updated_at'
    ];
    const rows = [];
    rows.push(header.join(','));

    state.works.forEach(work => {
      work.chapters.forEach((ch, idx) => {
        rows.push([
          csvEscape(work.id),
          csvEscape(work.genre || ''),
          csvEscape(work.title || ''),
          csvEscape(work.author || ''),
          csvEscape(work.isBackup ? '1':'0'),
          csvEscape(work.coverDataUrl || ''),
          csvEscape(String(idx)),
          csvEscape(ch.content || ''),
          csvEscape(ch.updatedAt || '')
        ].join(','));
      });
    });

    const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const stamp = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = 'studio-novel-' + stamp + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    log(`Eksport: ${state.works.length} karya.`);
  }

  function importFromCsvText(text){
    const rawLines = text.replace(/\r/g,'').split('\n');

    // rebuild logical rows (respect quoted newlines)
    const lines = [];
    let buf = '';

    for(const ln of rawLines){
      buf = buf ? (buf + '\n' + ln) : ln;

      const m = buf.match(/"/g);
      const quoteCount = m ? m.length : 0;

      if(quoteCount % 2 === 0){
        if(buf.trim().length) lines.push(buf);
        buf = '';
      }
    }
    if(buf.trim().length) lines.push(buf);

    if(lines.length <= 1){
      alert('Fail CSV kosong atau tidak sah.');
      log('Import gagal: CSV kosong.');
      return;
    }

    const header = lines[0].split(',');
    const idx = (name) => header.indexOf(name);

    if(idx('work_id') === -1 || idx('chapter_index') === -1 || idx('content') === -1){
      alert('Format CSV tidak sepadan. Sila eksport dari aplikasi ini dahulu.');
      log('Import gagal: header tidak sepadan.');
      return;
    }

    const worksMap = {};
    let rowOk = 0;

    for(let i=1;i<lines.length;i++){
      const cols = parseCsvLine(lines[i]);

      const workId = cols[idx('work_id')] || '';
      if(!workId) continue;

      const genre = cols[idx('genre')] || '';
      const title = cols[idx('title')] || '';
      const author = cols[idx('author')] || 'Mazlee Ahmad';
      const isBackup = (cols[idx('is_backup')] || '0') === '1';
      const cover = cols[idx('cover_dataurl')] || '';
      const chIndex = parseInt(cols[idx('chapter_index')] || '0', 10) || 0;
      const content = cols[idx('content')] || '';
      const updatedAt = cols[idx('updated_at')] || null;

      if(!worksMap[workId]){
        worksMap[workId] = {
          id: workId,
          genre,
          title,
          author,
          isBackup,
          coverDataUrl: cover,
          chapters: []
        };
      }
      const w = worksMap[workId];
      if(cover && !w.coverDataUrl) w.coverDataUrl = cover;
      w.chapters[chIndex] = {content, updatedAt};
      rowOk++;
    }

    const importedWorks = Object.values(worksMap).map(w => {
      w.chapters = w.chapters.filter(Boolean);
      if(w.chapters.length === 0) w.chapters = [{content:'',updatedAt:null}];
      if(typeof w.coverDataUrl !== 'string') w.coverDataUrl = '';
      if(!w.author) w.author = 'Mazlee Ahmad';
      return w;
    });

    state.works = importedWorks;
    state.currentWorkId = state.works[0]?.id || null;
    state.currentChapterIndex = 0;
    state.isDirty = false;

    saveToStorage();
    renderWorkList();
    renderEditor();

    alert('Import CSV selesai. ' + state.works.length + ' karya dimuatkan.');
    log(`Import OK: rows=${rowOk}, karya=${state.works.length}`);
  }

  function handleImportCsvFile(e){
    const file = e.target.files[0];
    if(!file) return;

    if(!confirmIfDirty()){ e.target.value = ''; return; }
    if(!confirm('Import CSV akan menggantikan semua karya semasa. Teruskan?')){
      e.target.value = ''; return;
    }

    const reader = new FileReader();
    reader.onload = (ev) => {
      try{
        importFromCsvText(ev.target.result);
      }catch(err){
        console.error(err);
        alert('Gagal memproses CSV.');
        log('Import gagal: exception.');
      }finally{
        e.target.value = '';
      }
    };
    reader.readAsText(file);
  }

  // ===== Book mode =====
  function escapeHtml(str){
    return (str || '').replace(/[&<>"']/g, m => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
    ));
  }

  function paginateText(text, charsPerPage){
    if(!text) return [];
    const paras = text.replace(/\r/g,'').split(/\n{2,}/);
    const pages = [];
    let buf = '';

    function pushBuf(){ pages.push(buf.trim()); buf=''; }

    for(const p of paras){
      const chunk = p.trim();
      if(!chunk) continue;

      if(chunk.length > charsPerPage){
        const pieces = softSplit(chunk, charsPerPage);
        for(const piece of pieces){
          const cand = buf ? (buf + '\n\n' + piece) : piece;
          if(cand.length > charsPerPage){
            if(buf.trim()) pushBuf();
            buf = piece;
          }else buf = cand;
        }
        continue;
      }

      const candidate = buf ? (buf + '\n\n' + chunk) : chunk;
      if(candidate.length > charsPerPage){
        if(buf.trim()) pushBuf();
        buf = chunk;
      }else buf = candidate;
    }
    if(buf.trim()) pushBuf();
    return pages;
  }

  function softSplit(s, limit){
    const out = [];
    let i = 0;
    while(i < s.length){
      let end = Math.min(i + limit, s.length);
      if(end < s.length){
        const back = s.lastIndexOf(' ', end);
        if(back > i + Math.floor(limit*0.55)) end = back;
      }
      out.push(s.slice(i, end).trim());
      i = end;
    }
    return out.filter(Boolean);
  }

  function makeBookPages(w){
    const pages = [];

    const coverHtml = `
      <div class="cover">
        <div>
          <div class="coverTitle">${escapeHtml(w.title || 'Karya')}</div>
          <div class="coverAuthor">${escapeHtml(w.author || 'Penulis')}</div>
        </div>
        <div class="coverImg">
          ${w.coverDataUrl ? `<img src="${w.coverDataUrl}" alt="cover">`
            : `<div style="font-size:12px;color:#6b7280;">(Tiada cover)</div>`}
        </div>
        <div class="coverFooter">
          <span>${escapeHtml(w.genre || '')}</span>
          <span>${new Date().toLocaleDateString('ms-MY')}</span>
        </div>
      </div>`;
    pages.push({type:'html', title:'Cover', content:coverHtml});

    const tocLines = w.chapters.map((_, i) => `Bab ${i+1}`).join('\n');
    const tocHtml = `
      <div>
        <div class="h1">Kandungan</div>
        <div class="h2">${escapeHtml(w.title || '')}</div>
        <div style="white-space:pre-wrap;line-height:1.9;font-size:14px;">${escapeHtml(tocLines)}</div>
      </div>`;
    pages.push({type:'html', title:'TOC', content:tocHtml});

    const CHARS_PER_PAGE = 2000;

    w.chapters.forEach((ch, idx) => {
      const title = `Bab ${idx+1}`;
      const raw = (ch.content || '').trim();
      const blocks = paginateText(raw, CHARS_PER_PAGE);

      if(blocks.length === 0){
        pages.push({type:'text', title, header:true, content:''});
      }else{
        blocks.forEach((b, bi) => {
          pages.push({type:'text', title, header:(bi===0), content:b});
        });
      }
    });

    return pages;
  }

  function renderBookPage(targetEl, page){
    if(!page){ targetEl.innerHTML=''; return; }
    if(page.type === 'html'){ targetEl.innerHTML = page.content; return; }
    const header = page.header ? `<div class="h1">${escapeHtml(page.title)}</div>` : '';
    targetEl.innerHTML = `${header}<div style="white-space:pre-wrap;line-height:1.65;font-size:14px;">${escapeHtml(page.content||'')}</div>`;
  }

  function renderBookSpread(){
    const pages = state.bookPages;
    const i = state.bookIndex;
    const left = pages[i] || null;
    const right = pages[i+1] || null;

    renderBookPage(els.bookLeft, left);
    renderBookPage(els.bookRight, right);

    const baseNum = Math.max(0, i - 1); // after cover+toc
    els.pnumLeft.textContent = (left && i>1) ? String(baseNum) : '';
    els.pnumRight.textContent = (right && (i+1)>1) ? String(baseNum+1) : '';

    const totalReadable = Math.max(0, pages.length - 2);
    const currentReadable = Math.max(0, i - 1);
    els.bookCounter.textContent =
      `Halaman ${Math.min(currentReadable,totalReadable)} / ${totalReadable}`;

    els.btnBookPrev.disabled = (i <= 0);
    els.btnBookNext.disabled = (i >= pages.length - 1);
  }

  function openBookMode(){
    const w = getCurrentWork();
    if(!w) return;
    syncEditorToState();
    state.bookPages = makeBookPages(w);
    state.bookIndex = 0;

    els.bookTitle.textContent = w.title || 'Karya';
    els.bookMeta.textContent = (w.genre ? (w.genre + ' · ') : '') + (w.author || 'Penulis');

    els.bookOverlay.classList.add('show');
    els.bookOverlay.setAttribute('aria-hidden','false');
    renderBookSpread();
    log('Mod Buku dibuka.');
  }

  function closeBookMode(){
    els.bookOverlay.classList.remove('show');
    els.bookOverlay.setAttribute('aria-hidden','true');
    log('Mod Buku ditutup.');
  }

  function bookNext(){
    if(state.bookIndex >= state.bookPages.length - 1) return;
    const isMobile = window.matchMedia('(max-width: 800px)').matches;
    state.bookIndex += isMobile ? 1 : 2;
    state.bookIndex = Math.min(state.bookIndex, state.bookPages.length - 1);
    renderBookSpread();
  }

  function bookPrev(){
    if(state.bookIndex <= 0) return;
    const isMobile = window.matchMedia('(max-width: 800px)').matches;
    state.bookIndex -= isMobile ? 1 : 2;
    state.bookIndex = Math.max(state.bookIndex, 0);
    renderBookSpread();
  }

  // ===== Reset =====
  function handleReset(){
    if(!confirm('Reset akan memadam semua data dalam app ini (localStorage). Teruskan?')) return;
    localStorage.removeItem(STORAGE_KEY);
    state.works = [];
    state.currentWorkId = null;
    state.currentChapterIndex = 0;
    state.isDirty = false;
    state.lastSavedAt = null;
    renderWorkList();
    renderEditor();
    log('Reset selesai.');
  }

  // ===== Events =====
  function initEvents(){
    els.btnNewWork.addEventListener('click', handleNewWork);
    els.genreFilter.addEventListener('change', renderWorkList);

    els.genreInput.addEventListener('change', handleGenreChange);
    els.titleInput.addEventListener('input', handleTitleChange);
    els.chapterContent.addEventListener('input', handleContentInput);

    els.btnSave.addEventListener('click', handleSave);
    els.btnDuplicate.addEventListener('click', handleDuplicate);
    els.btnAddChapter.addEventListener('click', handleAddChapter);

    els.btnExportCsv.addEventListener('click', handleExportCsv);
    els.importCsvInput.addEventListener('change', handleImportCsvFile);
    els.btnReset.addEventListener('click', handleReset);

    els.coverInput.addEventListener('change', handleCoverUpload);
    els.btnRemoveCover.addEventListener('click', handleRemoveCover);

    els.btnBookMode.addEventListener('click', () => {
      if(state.isDirty){
        if(confirm('Ada perubahan belum disimpan. Mod Buku gunakan teks terkini tanpa simpan. Teruskan?')){
          openBookMode();
        }
        return;
      }
      openBookMode();
    });

    els.btnBookClose.addEventListener('click', closeBookMode);
    els.btnBookNext.addEventListener('click', bookNext);
    els.btnBookPrev.addEventListener('click', bookPrev);

    els.bookOverlay.addEventListener('click', (ev) => {
      if(ev.target === els.bookOverlay) closeBookMode();
    });

    window.addEventListener('keydown', (ev) => {
      if(!els.bookOverlay.classList.contains('show')) return;
      if(ev.key === 'Escape') closeBookMode();
      if(ev.key === 'ArrowRight') bookNext();
      if(ev.key === 'ArrowLeft') bookPrev();
    });

    window.addEventListener('beforeunload', (e) => {
      if(!state.isDirty) return;
      e.preventDefault();
      e.returnValue = '';
    });

    window.addEventListener('resize', () => {
      if(els.bookOverlay.classList.contains('show')) renderBookSpread();
    });
  }

  function init(){
    loadFromStorage();

    // Ensure structure
    state.works.forEach(w => {
      if(!w.author) w.author = 'Mazlee Ahmad';
      if(typeof w.coverDataUrl !== 'string') w.coverDataUrl = '';
      if(!Array.isArray(w.chapters)) w.chapters = [{content:'',updatedAt:null}];
      if(w.chapters.length === 0) w.chapters = [{content:'',updatedAt:null}];
    });

    state.currentWorkId = state.works[0]?.id || null;

    initEvents();
    renderWorkList();
    renderEditor();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
